AWSTemplateFormatVersion: '2010-09-09'
Description: 'Multi-Account Transit Gateway Demo - Simulates cross-account connectivity patterns'

# MULTI-ACCOUNT ARCHITECTURE SIMULATION
# In production, this would be deployed across 3 accounts:
# - Management Account: AWS Organizations, billing, Transit Gateway (shared via RAM)
# - Workload Account A: VPC-A (10.0.0.0/16) with application workloads
# - Workload Account B: VPC-B (10.1.0.0/16) with application workloads

Parameters:
  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: EC2 Key Pair for SSH access
  
  Environment:
    Type: String
    Default: 'multi-account-demo'
    Description: Environment tag for all resources

  LatestAmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64
    Description: Latest Amazon Linux 2023 AMI ID
    
Resources:
  # MANAGEMENT ACCOUNT RESOURCES
  # In production: Deploy in Management Account
  # Purpose: AWS Organizations, billing, shared Transit Gateway
  
  TransitGateway:
    Type: AWS::EC2::TransitGateway
    Properties:
      AmazonSideAsn: 64512
      Description: 'Multi-Account Transit Gateway - Management Account'
      Tags:
        - Key: Name
          Value: MultiAccount-TGW
        - Key: Environment
          Value: !Ref Environment
        - Key: Account-Role
          Value: Management
        - Key: Purpose
          Value: Cross-account-connectivity

  # RAM Resource Share - In production, this shares TGW to workload accounts
  TGWResourceShare:
    Type: AWS::RAM::ResourceShare
    Properties:
      Name: 'TGW-Cross-Account-Share'
      ResourceArns:
        - !Sub 'arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:transit-gateway/${TransitGateway}'
      # In production, add target account IDs here:
      # Principals:
      #   - '222222222222'  # Workload Account A
      #   - '333333333333'  # Workload Account B
      Tags:
        - Key: Name
          Value: TGW-RAM-Share
        - Key: Account-Role
          Value: Management
        - Key: Purpose
          Value: Cross-account-TGW-sharing

  # TGW Route Table for cross-account routing
  TGWRouteTable:
    Type: AWS::EC2::TransitGatewayRouteTable
    Properties:
      TransitGatewayId: !Ref TransitGateway
      Tags:
        - Key: Name
          Value: TGW-RouteTable
        - Key: Account-Role
          Value: Management

  # WORKLOAD ACCOUNT A RESOURCES  
  # In production: Deploy in dedicated Workload Account A
  # Purpose: Application workloads, databases, compute resources
  
  VPCProduction:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16  # Workload A CIDR block
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: VPC-Workload-A
        - Key: Environment
          Value: !Ref Environment
        - Key: Account-Role
          Value: Workload-A
        - Key: Data-Classification
          Value: Application-Data

  # Production Subnets - Multi-AZ for high availability
  ProdAppSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPCProduction
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: Production-App-Subnet
        - Key: Account-Role
          Value: Production
        - Key: Tier
          Value: Application

  ProdDBSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPCProduction
      CidrBlock: 10.0.10.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: Production-DB-Subnet
        - Key: Account-Role
          Value: Production
        - Key: Tier
          Value: Database

  ProdTGWSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPCProduction
      CidrBlock: 10.0.255.0/28
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: Production-TGW-Subnet
        - Key: Account-Role
          Value: Production
        - Key: Purpose
          Value: Transit-Gateway-Attachment

  # WORKLOAD ACCOUNT B RESOURCES
  # In production: Deploy in dedicated Workload Account B  
  # Purpose: Application workloads, databases, compute resources
  
  VPCDevTest:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.1.0.0/16  # Workload B CIDR block
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: VPC-Workload-B
        - Key: Environment
          Value: !Ref Environment
        - Key: Account-Role
          Value: Workload-B
        - Key: Data-Classification
          Value: Application-Data

  # Dev/Test Subnets - Cost-optimized, single AZ acceptable
  DevTestAppSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPCDevTest
      CidrBlock: 10.1.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: DevTest-App-Subnet
        - Key: Account-Role
          Value: DevTest
        - Key: Tier
          Value: Application

  DevTestDBSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPCDevTest
      CidrBlock: 10.1.10.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: DevTest-DB-Subnet
        - Key: Account-Role
          Value: DevTest
        - Key: Tier
          Value: Database

  DevTestTGWSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPCDevTest
      CidrBlock: 10.1.255.0/28
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: DevTest-TGW-Subnet
        - Key: Account-Role
          Value: DevTest
        - Key: Purpose
          Value: Transit-Gateway-Attachment

  # CROSS-ACCOUNT CONNECTIVITY
  # In production: These would be cross-account attachments using RAM sharing
  # The Infrastructure Account would share the TGW via Resource Access Manager
  # Production and Dev/Test accounts would create attachments to the shared TGW
  
  TGWAttachmentProduction:
    Type: AWS::EC2::TransitGatewayAttachment
    Properties:
      TransitGatewayId: !Ref TransitGateway
      VpcId: !Ref VPCProduction
      SubnetIds:
        - !Ref ProdTGWSubnet
      Tags:
        - Key: Name
          Value: TGW-Attachment-Workload-A
        - Key: Account-Role
          Value: Workload-A
        - Key: Cross-Account
          Value: 'true'

  TGWAttachmentDevTest:
    Type: AWS::EC2::TransitGatewayAttachment
    Properties:
      TransitGatewayId: !Ref TransitGateway
      VpcId: !Ref VPCDevTest
      SubnetIds:
        - !Ref DevTestTGWSubnet
      Tags:
        - Key: Name
          Value: TGW-Attachment-Workload-B
        - Key: Account-Role
          Value: Workload-B
        - Key: Cross-Account
          Value: 'true'

  # Associate attachments with TGW route table
  TGWRouteTableAssociationA:
    Type: AWS::EC2::TransitGatewayRouteTableAssociation
    Properties:
      TransitGatewayAttachmentId: !Ref TGWAttachmentProduction
      TransitGatewayRouteTableId: !Ref TGWRouteTable

  TGWRouteTableAssociationB:
    Type: AWS::EC2::TransitGatewayRouteTableAssociation
    Properties:
      TransitGatewayAttachmentId: !Ref TGWAttachmentDevTest
      TransitGatewayRouteTableId: !Ref TGWRouteTable

  # Propagate routes for cross-account connectivity
  TGWRouteTablePropagationA:
    Type: AWS::EC2::TransitGatewayRouteTablePropagation
    Properties:
      TransitGatewayAttachmentId: !Ref TGWAttachmentProduction
      TransitGatewayRouteTableId: !Ref TGWRouteTable

  TGWRouteTablePropagationB:
    Type: AWS::EC2::TransitGatewayRouteTablePropagation
    Properties:
      TransitGatewayAttachmentId: !Ref TGWAttachmentDevTest
      TransitGatewayRouteTableId: !Ref TGWRouteTable

  # ROUTING CONFIGURATION
  # In production: Route tables would be managed within each account
  # with routes pointing to the shared Transit Gateway
  
  ProductionRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPCProduction
      Tags:
        - Key: Name
          Value: Production-RouteTable
        - Key: Account-Role
          Value: Production

  DevTestRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPCDevTest
      Tags:
        - Key: Name
          Value: DevTest-RouteTable
        - Key: Account-Role
          Value: DevTest

  # Cross-account routes (in production, these would route to shared TGW)
  ProductionToDevTestRoute:
    Type: AWS::EC2::Route
    DependsOn: TGWAttachmentProduction
    Properties:
      RouteTableId: !Ref ProductionRouteTable
      DestinationCidrBlock: 10.1.0.0/16  # Route to Dev/Test account CIDR
      TransitGatewayId: !Ref TransitGateway

  DevTestToProductionRoute:
    Type: AWS::EC2::Route
    DependsOn: TGWAttachmentDevTest
    Properties:
      RouteTableId: !Ref DevTestRouteTable
      DestinationCidrBlock: 10.0.0.0/16  # Route to Production account CIDR
      TransitGatewayId: !Ref TransitGateway

  # Associate subnets with route tables
  ProdAppSubnetAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref ProdAppSubnet
      RouteTableId: !Ref ProductionRouteTable

  DevTestAppSubnetAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref DevTestAppSubnet
      RouteTableId: !Ref DevTestRouteTable

  # SECURITY GROUPS
  # In production: Different security postures per account
  
  ProductionSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: 'Production Security Group - Restrictive access'
      VpcId: !Ref VPCProduction
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 10.1.0.0/16  # Only allow SSH from Dev/Test account
          Description: 'SSH from Dev/Test account for troubleshooting'
      Tags:
        - Key: Name
          Value: Production-SecurityGroup
        - Key: Account-Role
          Value: Production
        - Key: Security-Level
          Value: Restrictive

  DevTestSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: 'Dev/Test Security Group - More permissive for development'
      VpcId: !Ref VPCDevTest
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 10.0.0.0/8  # More permissive for development
          Description: 'SSH access for development and testing'
      Tags:
        - Key: Name
          Value: DevTest-SecurityGroup
        - Key: Account-Role
          Value: DevTest
        - Key: Security-Level
          Value: Development

  # TEST INSTANCES
  # In production: These would be in their respective accounts
  
  ProductionInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref LatestAmiId
      InstanceType: t3.micro
      KeyName: !Ref KeyPairName
      SubnetId: !Ref ProdAppSubnet
      SecurityGroupIds:
        - !Ref ProductionSecurityGroup
      PrivateIpAddress: 10.0.1.10
      Tags:
        - Key: Name
          Value: Workload-A-Instance
        - Key: Account-Role
          Value: Workload-A
        - Key: Environment
          Value: !Ref Environment

  DevTestInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref LatestAmiId
      InstanceType: t3.micro
      KeyName: !Ref KeyPairName
      SubnetId: !Ref DevTestAppSubnet
      SecurityGroupIds:
        - !Ref DevTestSecurityGroup
      PrivateIpAddress: 10.1.1.10
      Tags:
        - Key: Name
          Value: Workload-B-Instance
        - Key: Account-Role
          Value: Workload-B
        - Key: Environment
          Value: !Ref Environment

Outputs:
  # Management Account Outputs
  TransitGatewayId:
    Description: 'Transit Gateway ID (Management Account)'
    Value: !Ref TransitGateway
    Export:
      Name: !Sub '${AWS::StackName}-TGW-ID'
  
  # Workload Account A Outputs
  WorkloadAVPCId:
    Description: 'Workload Account A VPC ID'
    Value: !Ref VPCProduction
    Export:
      Name: !Sub '${AWS::StackName}-WorkloadA-VPC-ID'
    
  WorkloadAInstanceIP:
    Description: 'Workload A Instance Private IP'
    Value: !GetAtt ProductionInstance.PrivateIp
    
  # Workload Account B Outputs  
  WorkloadBVPCId:
    Description: 'Workload Account B VPC ID'
    Value: !Ref VPCDevTest
    Export:
      Name: !Sub '${AWS::StackName}-WorkloadB-VPC-ID'
    
  WorkloadBInstanceIP:
    Description: 'Workload B Instance Private IP'
    Value: !GetAtt DevTestInstance.PrivateIp

  # Multi-Account Architecture Summary
  ArchitectureNotes:
    Description: 'Multi-Account Architecture Implementation Notes'
    Value: 'This template simulates a 3-account architecture: Management (TGW + RAM sharing), Workload A (10.0.0.0/16), and Workload B (10.1.0.0/16). In production, deploy across separate accounts with TGW shared via RAM.'
